<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Worship Graphic Control</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
<script src="/javascripts/jquery.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
	html, body {
		margin: 0px;
		color: white;
		background: black;
		height: 100%;
		text-align: center;
		overflow-y: hidden;
		overflow-x: hidden;
		font-family: arial;
		font-size: 45px;
	}
	#mediaplayer {
		width: 90%;
		margin-top: 1em;
		margin-left: auto;
		margin-right: auto;
	}
	#mplayer {
		max-width: 100%;
		height: auto;
	}
	#center {
		display: none;
		margin-top: 1em;
		margin-right: auto;
		margin-left: auto;
		text-align: right;
		font-size: 0.23em;
	}
	.programitem {
		background: #666;
		width: 75%;
		min-width: 550px;
		margin-left: auto;
		margin-right: auto;
	}
	.programdetail {
		margin: 4px;
		padding: .2em;
		border: 0px;
		font-size: 1em;
		font-weight: bold;
		color: #333;
		width: 70%
	}
	#programclose {
		width: 10em;
		margin: 3px;
		padding: .2em;
		font-size: 1em;
		color: #333;
	}
	#bottombanner {
		position: absolute;
		width: 100%;
		height: 15%;
		bottom: 0px;
	}
	#bottombanner.reveal>#bottomtext {
		/* width: 75%; */
		border-right: 2px solid white;
	}
	#bottombanner.reveal>#clock {
		/* width: 25%; */
		border-top: 2px solid white;
		/* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#596a72+0,9ca2ad+100 */
		background: #596a72; /* Old browsers */
		background: -moz-linear-gradient(left, #596a72 0%, #9ca2ad 100%); /* FF3.6-15 */
		background: -webkit-linear-gradient(left, #596a72 0%,#9ca2ad 100%); /* Chrome10-25,Safari5.1-6 */
		background: linear-gradient(to right, #596a72 0%,#9ca2ad 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#596a72', endColorstr='#9ca2ad',GradientType=1 ); /* IE6-9 */
		/* Generated by: http://www.colorzilla.com/gradient-editor/ */
	}
	#bottomtext {
		position: absolute;
		left: 0px;
		bottom: 0px;
		width: 0%;
		height: 100%;
		padding-top: 2px;
		font-weight: bold;
		text-shadow: 0px 0px 5px #000;
	}
	#bottomtext>.partname {
		font-style: italic;
		font-size: 0.9em;
	}
	#bottomtext>.parttitle {
		font-size: 0.7em;
	}
	#clock {
		position: absolute;
		right: 0px;
		bottom: 0px;
		/* border-left: 2px solid #fff; */
		padding-top: 2px;
		float: right;
		width: 100%;
		height: 100%;
		text-align: right;
		background: none;
		text-shadow: 0px 0px 4px #999;
    -webkit-transition: width 1s ease-in-out; /* Safari */
    transition: width 1s ease-in-out;
	}
	#time {
		/* padding-left: .5em; */
	}
	#seconds {
		padding-right: 2em;
		font-size: .75em;
	}
	#upperbug span.bug {
		font-size: 0.75em;
		padding-right: 0.6em;
	}
	#lowerbug {
		height: 1em;
	}
	#lowerbug span.bug {
		vertical-align: top;
		font-size: 0.5em;
		padding-right: 0.75em;
	}
	/*	
	.blackbg {
		border-top: 2px solid black;
		background: black;
	}
	*/
	.graybg {
		border-top: 2px solid white;
		/* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#596a72+0,9ca2ad+100 */
		background: #596a72; /* Old browsers */
		background: -moz-linear-gradient(left, #596a72 0%, #9ca2ad 100%); /* FF3.6-15 */
		background: -webkit-linear-gradient(left, #596a72 0%,#9ca2ad 100%); /* Chrome10-25,Safari5.1-6 */
		background: linear-gradient(to right, #596a72 0%,#9ca2ad 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#596a72', endColorstr='#9ca2ad',GradientType=1 ); /* IE6-9 */
		/* Generated by: http://www.colorzilla.com/gradient-editor/ */
	}
	.bluebg {
		border-top: 2px solid white;
		/* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#3b5191+0,a5bef7+100 */
		background: #3b5191; /* Old browsers */
		background: -moz-linear-gradient(left, #3b5191 0%, #a5bef7 100%); /* FF3.6-15 */
		background: -webkit-linear-gradient(left, #3b5191 0%,#a5bef7 100%); /* Chrome10-25,Safari5.1-6 */
		background: linear-gradient(to right, #3b5191 0%,#a5bef7 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#3b5191', endColorstr='#a5bef7',GradientType=1 ); /* IE6-9 */
		/* Generated by: http://www.colorzilla.com/gradient-editor/ */
	}
	.inputChanged {
		background: #a5bef7;
	}
</style>
</head>
<body id="body">
<div class="container">
	<div id="mediaplayer"></div>
</div>
<div id="bottombanner">
	<div id="clock" class="blackbg">
		<div id="upperbug" class="bug">
			<span id="time"></span><span id="seconds"></span>	
		</div>
		<div id="lowerbug" class="bug"></div>
	</div>
	<div id="bottomtext" class="bluebg"></div>
</div>
<script>
	var originalBannerSize = "15%";
	var bannerResizeAmount = 10;
	var animateSpeed = 200;
	var program;
	
	// Load socket.io client
	var socket = io();

	// Set up app object with command methods
	var programctl = {};
	programctl.mplayer = {};
	//programctl.mediaqueue = [];
	//programctl.currentlyPlayingIndex = null;
	programctl.writeBanner = function(param) {
		writeBanner(getPart(param),function() {
			programctl.writeBannerComplete(param);
		});
	};
	programctl.clear = function() {
		writeBanner('',function() {
			programctl.writeBannerComplete();
		});
	};
	programctl.getprogram = function() {
		socket.emit('getprogram');
	};
	/*
	programctl.queuemedia = function(file) {
		this.mediaqueue.push(file);
		socket.emit('queuelist',JSON.stringify(this.mediaqueue));
	};
	*/
	programctl.findmedia = function(file) {
		return this.mediaqueue.indexOf(file);
	};
	programctl.dequeuemedia = function(file) {
		//alert("Dequeueing file: " + file);
		var loc = this.mediaqueue.indexOf(file);
		if(loc>-1) this.mediaqueue.splice(loc,1);
		socket.emit('queuelist',JSON.stringify(this.mediaqueue));
	};
	programctl.mediaplay = function(file) {
		//alert("Going to play: " + file);
		var mediaplayerType = "video";
		$("#mediaplayer").empty();
		clearInterval(programctl.mediaProgressCounter);
		var imageRegex = /\.png$|\.jpg$|\.gif$/i;
		if(imageRegex.test(file)) {
			mediaplayerType = "img";
		}
		var mplayerString = "<" + mediaplayerType + " id=\"mplayer\" src=\"" + file + "\"/>";
		$("#mediaplayer").append(mplayerString);
		programctl.mplayer = document.getElementById("mplayer");
		socket.emit('mediaplaying',file);
		programctl.mplayer.play();
		//programctl.currentlyPlayingIndex = index;
		programctl.mediaProgressCounter = setInterval(function() {
			programctl.mediaprogress();
		},3000);
	};
	programctl.mediaprogress = function() {
		socket.emit('mediaprogress',this.mplayer.played.end(0));
	};
	programctl.mediastop = function() {
		clearInterval(this.mediaProgressCounter);
		programctl.mplayer.pause();
		programctl.mplayer.currentTime = 0;
		socket.emit('command',{command:'mediastopped'});
		socket.emit('mediaprogress',0);
	};
	programctl.mediapause = function() {
		clearInterval(this.mediaProgressCounter);
		programctl.mplayer.pause();
		socket.emit('command',{command:'mediapaused'});
	};
	programctl.clearmedia = function() {
		$("#mediaplayer").empty();
	};
	programctl.writeBannerComplete = function(partNum) {
		//alert("Sending banner complete: " + partNum);
		socket.emit('bannercomplete',partNum)
	};

	// set up the socket communication
	socket.on("command",function(msg) {
		//alert("Got command: " + msg.command + ": " + msg.param);
		if(programctl.hasOwnProperty(msg.command)) programctl[msg.command](msg.param);
	});
	
	socket.on('mediaplay',function(file) {
		programctl.mediaplay(file);
	});
	
	socket.on('queuelist',function(list) {
		list = JSON.parse(list);
		if(list.indexOf($("#mplayer").attr("src"))==-1) {
			programctl.clearmedia();
		}
	});

  socket.on("program",function(data) {
    program = JSON.parse(data);
		if(program.bug.trim().length==0) {
			setInterval(writeTime,1000);
		} else {
			var bugString = program.bug.split('|');
			$("#upperbug").html("<span class='bug'>" + bugString[0] + "</span>");
			if(bugString.length>1) $("#lowerbug").html("<span class='bug'>" + bugString[1] + "</span>");
		}
  });
	
	var formatNum = function(places, number, placeholder) {
		var outputString = number.toString();
		var len = outputString.length;
		for(x=(places-len); x>0; x--) {
			outputString = placeholder + outputString;
		}
		return outputString;
	};
	
	var writeTime = function() {
		var dt = new Date();
		var time = document.getElementById('time');
		var seconds = document.getElementById('seconds');
		time.innerHTML = formatNum(2,dt.getHours(),'0') + ":" + formatNum(2,dt.getMinutes(),'0');
		seconds.innerHTML = "&nbsp;" + formatNum(2,dt.getSeconds(),'0');
	};
	
	var writeText = function(string) {
		$("#bottomtext").text(string);
	};

	var revealBottomText = function(string,callback) {
		var writeText = function() {
			$("#bottomtext").html(string);
			if(callback) callback();
		};
		$("#bottombanner").addClass("reveal");
		$("#clock").animate({width: '75%'},animateSpeed,"swing",writeText());
	};
	
	var hideBottomText = function(callback) {
		$("#bottomtext").empty();
		//$("#clock").removeClass("graybg");
		$("#clock").animate({width: '0px'},animateSpeed);
		if(callback) callback();
		$("#bottombanner").removeClass("reveal");
	};
	
	var writeBanner = function(string,callback) {
		var s = string || null;
		if(s!==null && s.length>0) {
			revealBottomText(s,callback);
		} else {
			//alert("Hiding");
			hideBottomText(callback);
		}
	};
	
	var resizeBanner = function(amount) {
		if(amount == 1 || amount == -1) {
			var newBannerHeight = $("#bottombanner").height() + (bannerResizeAmount * amount);
			$("#bottombanner").height(newBannerHeight);
		} else {
			$("#bottombanner").height(amount);
		}
	};
		
	var getPart = function(num) {
		var returnString = "";
		if(program.hasOwnProperty(num)) {
			returnString += "<div class='partname'>" + program[num] + "</div>";
			if(num=="chairman1")
				returnString += "<div class='parttitle'>Chairman</div>";
			if(num=="title") {
				if(program.hasOwnProperty("subtitle")) returnString += "<div class='parttitle'>" + program.subtitle + "</div>";
			}
			return returnString;
		}
		if(!program.hasOwnProperty("parts")) return returnString;
		if(!program.parts.hasOwnProperty(num)) return returnString;
		if(program.parts[num].hasOwnProperty("name")) returnString += "<div class='partname'>" + program.parts[num].name + "</div>";
		if(program.parts[num].hasOwnProperty("title")) returnString += "<div class='parttitle'>" + program.parts[num].title + "</div>";
		return returnString;
	};
	
	$(document).keyup(function(event) {
		var theChar = event.which;
		if (theChar == 48 || theChar == 96) {
			/* 0 */
			programctl.writeBanner("chairman1");
		} else if (theChar == 49 || theChar == 97) {
			/* 1 */
			programctl.writeBanner(0);
		} else if (theChar == 50 || theChar == 98) {
			/* 2 */
			programctl.writeBanner(1);
		} else if (theChar == 51 || theChar == 99) {
			/* 3 */
			programctl.writeBanner(2);
		} else if (theChar == 52 || theChar == 100) {
			/* 4 */
			programctl.writeBanner(3);
		} else if (theChar == 53 || theChar == 101) {
			/* 5 */
			programctl.writeBanner(4);
		} else if (theChar == 54 || theChar == 102) {
			/* 6 */
			programctl.writeBanner(5);
		} else if (theChar == 55 || theChar == 103) {
			/* 7 */
			programctl.writeBanner(6);
		} else if (theChar == 56 || theChar == 104) {
			/* 8 */
			programctl.writeBanner(7);
		} else if (theChar == 57 || theChar == 105) {
			/* 9 */
			programctl.writeBanner(8);
		} else if (theChar == 80) {
			/* 'p' */
			/*
			var returnString = "";
			if(program.hasOwnProperty("chairman1")) {
				returnString += "<div class='partname'>" + program.chairman1 + "</div>";
				returnString += "<div class='parttitle'>Chairman</div>";
			}
			writeBanner(returnString);
			*/
			programctl.writeBanner("chairman1");
		} else if (theChar == 82) {
			/* 'r' */
			programctl.writeBanner("chairman2");
		} else if (theChar == 84) {
			/* 't' */
			var returnString = "";
			if(program.hasOwnProperty("title")) returnString += "<div class='partname'>" + program.title + "</div>";
			if(program.hasOwnProperty("subtitle")) returnString += "<div class='parttitle'>" + program.subtitle + "</div>";
			programctl.writeBanner(returnString);
		} else if (theChar == 66) {
			/* 'b' */
			programctl.writeBanner(mw[6]);
		} else if (theChar == 106) {
			/* '*' on numberpad */
			resizeBanner(originalBannerSize);
		} else if (theChar == 107) {
			/* '+' on numberpad */
			resizeBanner(1);
		} else if (theChar == 109) {
			/* '-' on numberpad*/
			resizeBanner(-1);
		} else {
			programctl.writeBanner("");
			//writeBanner(theChar.toString());
		}
	});
	/*
	$("input.programdetail").keyup(eventKeyUp);
	$("input.programdetail").blur(eventBlur);
	$(".programitem:last").css("text-align","center");
	$("#programclose").click(function() {
		$("#center").fadeToggle(animateSpeed);
	});
	*/
	$(document).ready(function() {
		//program = readFromStorage();
		programctl.getprogram();
		//fillInputs(program);
	});
</script>
</body>
</html>
